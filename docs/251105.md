# ì„¸ì…˜ ì¢…ë£Œ í›„ VAD ë©”íŠ¸ë¦­ìŠ¤ ë°ì´í„° ì†ì‹¤ ë¬¸ì œ í•´ê²° (2025-11-05)

## ğŸ“‹ ê°œìš”
ì„¸ì…˜ ì¢…ë£Œ ì‹œ WebSocket ì—°ê²°ì´ ëŠì–´ì§€ë©´ì„œ VAD ë©”íŠ¸ë¦­ìŠ¤(ìŒì„± ë¶„ì„ ë°ì´í„°) ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì–´ ê²°ê³¼ íƒ­ì—ì„œ "-" ê°’ë§Œ í‘œì‹œë˜ë˜ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ”´ ë¬¸ì œ ìƒí™©

### ì¦ìƒ
- ì‚¬ìš©ìê°€ ì„¸ì…˜ì„ ì¢…ë£Œí•œ í›„ ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
- VAD ë©”íŠ¸ë¦­ìŠ¤ ì„¹ì…˜ì—ì„œ ëª¨ë“  ê°’ì´ "-"ë¡œ í‘œì‹œë¨
- ì˜ˆ: ë°œí™” ë¹„ìœ¨ "-", ì¹¨ë¬µ ë¹„ìœ¨ "-", ë°œí™” íšŸìˆ˜ "-" ë“±

### ì‚¬ìš©ì ë³´ê³ 
```
"ì—¬ì „íˆ ê²°ê³¼ íƒ­ì—ì„œ ë­ê°€ ì•ˆ ìƒê¸°ëŠ”ë° ã…‹ã…‹"
```

### ì›ì¸ ë¶„ì„
1. **WebSocket ì˜ì¡´ì„±**: VAD ë©”íŠ¸ë¦­ìŠ¤ëŠ” ì„¸ì…˜ ì§„í–‰ ì¤‘ WebSocketì„ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” ë°ì´í„°
2. **ìƒíƒœ ì´ˆê¸°í™”**: ì„¸ì…˜ ì¢…ë£Œ ì‹œ WebSocketì´ ì¦‰ì‹œ ëŠì–´ì§€ë©´ì„œ `vadMetrics` ìƒíƒœê°€ `null`/`undefined`ë¡œ ì´ˆê¸°í™”
3. **ë°ì´í„° ì†ì‹¤**: SessionResult ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë  ë•Œ ì´ë¯¸ ë°ì´í„°ê°€ ì†ì‹¤ëœ ìƒíƒœ
4. **API í´ë°± ë¶ˆê°€**: VAD ë©”íŠ¸ë¦­ìŠ¤ëŠ” APIë¡œ ì¡°íšŒí•  ìˆ˜ ì—†ê³ , ì„¸ì…˜ ì¤‘ WebSocketìœ¼ë¡œë§Œ ìˆ˜ì‹  ê°€ëŠ¥

---

## ğŸ’¡ í•´ê²° ë°©ë²•

### ì „ëµ: localStorageë¥¼ ì´ìš©í•œ 2ë‹¨ê³„ ë°ì´í„° ë³´ì¡´

```
ì„¸ì…˜ ì§„í–‰ ì¤‘ (WebSocket í™œì„±)
    â†“
ì‚¬ìš©ìê°€ "ì¢…ë£Œ" ë²„íŠ¼ í´ë¦­
    â†“
[ì €ì¥ ë‹¨ê³„] App.tsxì˜ handleEndSession()
â”œâ”€ í˜„ì¬ vadMetrics ìƒíƒœê°’ ìº¡ì²˜
â”œâ”€ localStorageì˜ 'bemore_last_session' ì˜¤ë¸Œì íŠ¸ì— ì €ì¥
â””â”€ ë¡œê·¸ ì¶œë ¥: "âœ… VAD metrics saved to localStorage"
    â†“
WebSocket ì—°ê²° ì¢…ë£Œ (ìƒíƒœ ì´ˆê¸°í™”)
    â†“
ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
    â†“
[ë³µì› ë‹¨ê³„] SessionResult ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ
â”œâ”€ propsë¡œ ë°›ì€ vadMetrics í™•ì¸
â”œâ”€ ì—†ìœ¼ë©´ localStorageì—ì„œ 'bemore_last_session' ì¡°íšŒ
â”œâ”€ lastSession.vadMetrics ê°’ì´ ìˆìœ¼ë©´ ë¡œë“œ
â””â”€ ë¡œê·¸ ì¶œë ¥: "ğŸ¤ Loaded VAD metrics from localStorage"
    â†“
ê²°ê³¼ íƒ­ì— VAD ì •ë³´ ì •ìƒ í‘œì‹œ âœ…
```

### ìš°ì„ ìˆœìœ„
1. **Props ìš°ì„ **: SessionResultì— ì§ì ‘ ì „ë‹¬ëœ `vadMetrics` prop ì‚¬ìš©
2. **localStorage í´ë°±**: propì´ ì—†ìœ¼ë©´ localStorageì—ì„œ ë³µì›
3. **í‘œì‹œ ì•ˆ í•¨**: ë°ì´í„°ê°€ ì™„ì „íˆ ì—†ìœ¼ë©´ ì„¹ì…˜ ìˆ¨ê¹€

---

## ğŸ› ï¸ êµ¬í˜„ ìƒì„¸

### 1. App.tsx - VAD ë©”íŠ¸ë¦­ìŠ¤ ì €ì¥ (ë¼ì¸ 438-448)

```typescript
// ğŸ¬ 0ë‹¨ê³„: í˜„ì¬ VAD ë©”íŠ¸ë¦­ìŠ¤ë¥¼ localStorageì— ì €ì¥ (ê²°ê³¼ íƒ­ì—ì„œ í‘œì‹œí•˜ê¸° ìœ„í•´)
if (vadMetrics) {
  try {
    const lastSession = JSON.parse(localStorage.getItem('bemore_last_session') || '{}');
    lastSession.vadMetrics = vadMetrics;
    localStorage.setItem('bemore_last_session', JSON.stringify(lastSession));
    Logger.info('âœ… VAD metrics saved to localStorage', { vadMetrics });
  } catch (error) {
    Logger.warn('Failed to save VAD metrics to localStorage', { error });
  }
}
```

**ìœ„ì¹˜**: `handleEndSession()` í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ (WebSocket ì—°ê²° ì¢…ë£Œ ì „)

**ë™ì‘**:
- `vadMetrics` ìƒíƒœê°€ ìˆëŠ”ì§€ í™•ì¸
- localStorageì˜ ê¸°ì¡´ 'bemore_last_session' ê°ì²´ ë¡œë“œ
- `vadMetrics` ê°’ì„ ì¶”ê°€
- ë‹¤ì‹œ localStorageì— ì €ì¥
- ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸ ê¸°ë¡

---

### 2. SessionResult.tsx - VAD ë©”íŠ¸ë¦­ìŠ¤ ë³µì› (ë¼ì¸ 45-68)

```typescript
// ğŸ”§ FIX: Load VAD metrics from localStorage if prop is not provided
// When session ends and WebSocket disconnects, the parent may not have vadMetrics to pass
// Fallback to localStorage where we saved it during session end
useEffect(() => {
  if (!preservedVadMetrics && !vadMetrics && sessionId) {
    try {
      const lastSession = JSON.parse(localStorage.getItem('bemore_last_session') || '{}');
      if (lastSession.vadMetrics) {
        setPreservedVadMetrics(lastSession.vadMetrics);
        if (import.meta.env.DEV) {
          console.log('ğŸ¤ Loaded VAD metrics from localStorage:', {
            speechRatio: (lastSession.vadMetrics.speechRatio * 100).toFixed(1) + '%',
            pauseRatio: (lastSession.vadMetrics.pauseRatio * 100).toFixed(1) + '%',
            speechBurstCount: lastSession.vadMetrics.speechBurstCount,
          });
        }
      }
    } catch (error) {
      if (import.meta.env.DEV) {
        console.warn('Failed to load VAD metrics from localStorage:', error);
      }
    }
  }
}, [sessionId]);
```

**ìœ„ì¹˜**: SessionResult ì»´í¬ë„ŒíŠ¸ì˜ useEffect í›… (ë¼ì¸ 48-68)

**ì¡°ê±´**:
- `!preservedVadMetrics`: ë¡œì»¬ ìƒíƒœì— ë°ì´í„° ì—†ìŒ
- `!vadMetrics`: propsë¡œ ë°›ì€ ë°ì´í„°ë„ ì—†ìŒ
- `sessionId`: ì„¸ì…˜ IDê°€ ì¡´ì¬í•¨

**ë™ì‘**:
- localStorageì—ì„œ 'bemore_last_session' ì¡°íšŒ
- `lastSession.vadMetrics` í™•ì¸
- `preservedVadMetrics` ìƒíƒœì— ì„¤ì •
- ê°œë°œ í™˜ê²½ì—ì„œë§Œ ë¡œê·¸ ì¶œë ¥

---

## ğŸ“Š í‘œì‹œë˜ëŠ” VAD ë©”íŠ¸ë¦­ìŠ¤

SessionResultì˜ "ğŸ¤ ìŒì„± ë¶„ì„" ì„¹ì…˜ì—ì„œ ë‹¤ìŒ 6ê°€ì§€ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤:

| í•­ëª© | ê°’ | ì„¤ëª… |
|------|-----|------|
| ë°œí™” ë¹„ìœ¨ | 45.3% | ì „ì²´ ì„¸ì…˜ ì¤‘ ì‚¬ìš©ìê°€ ë§í•œ ì‹œê°„ ë¹„ìœ¨ |
| ì¹¨ë¬µ ë¹„ìœ¨ | 54.7% | ì „ì²´ ì„¸ì…˜ ì¤‘ ì¹¨ë¬µí•œ ì‹œê°„ ë¹„ìœ¨ |
| í‰ê·  ì¹¨ë¬µ | 2.34s | ì¹¨ë¬µ êµ¬ê°„ë“¤ì˜ í‰ê·  ì§€ì†ì‹œê°„ |
| ìµœì¥ ì¹¨ë¬µ | 12.56s | ê°€ì¥ ê¸´ ì¹¨ë¬µ êµ¬ê°„ì˜ ì§€ì†ì‹œê°„ |
| ë°œí™” íšŸìˆ˜ | 18 | ì„¸ì…˜ ì¤‘ ë§í•œ íšŸìˆ˜ |
| ì¹¨ë¬µ êµ¬ê°„ | 17 | ì¹¨ë¬µí•œ íšŸìˆ˜ |

---

## ğŸ“ ê´€ë ¨ íŒŒì¼ ë³€ê²½ì‚¬í•­

### ìˆ˜ì •ëœ íŒŒì¼
1. **src/App.tsx** (ë¼ì¸ 438-448)
   - VAD ë©”íŠ¸ë¦­ìŠ¤ ì €ì¥ ë¡œì§ ì¶”ê°€
   - handleEndSession() í•¨ìˆ˜ ìˆ˜ì •

2. **src/components/Session/SessionResult.tsx** (ë¼ì¸ 45-68)
   - localStorageì—ì„œ VAD ë©”íŠ¸ë¦­ìŠ¤ ë³µì› ë¡œì§ ì¶”ê°€
   - ìƒˆ useEffect í›… ì¶”ê°€

### ì°¸ê³ : ì´ì „ ê°œì„ ì‚¬í•­ë“¤

**src/services/api.ts** (ë¼ì¸ 22)
- API íƒ€ì„ì•„ì›ƒ ì¦ê°€: 20s â†’ 30s
- ì„¸ì…˜ ì¢…ë£Œ ì—”ë“œí¬ì¸íŠ¸ ìµœì í™”

**src/components/Session/ActiveSessionView.tsx**
- Toast ì•Œë¦¼ ì‹œìŠ¤í…œ ì¶”ê°€
- ì§„í–‰ ìƒí™© í”¼ë“œë°± ê°œì„ 
- ì—ëŸ¬ ì¬ì‹œë„ UI ê°œì„ 

---

## âœ… ì™„ë£Œ ìƒíƒœ

- âœ”ï¸ localStorage ì €ì¥ ë¡œì§ êµ¬í˜„ (App.tsx)
- âœ”ï¸ localStorage ë³µì› ë¡œì§ êµ¬í˜„ (SessionResult.tsx)
- âœ”ï¸ TypeScript íƒ€ì… ì²´í¬ í†µê³¼
- âœ”ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ ì„±ê³µ (253KB gzipped)
- âœ”ï¸ Git ì»¤ë°‹: `305e056` - VAD metrics persistence implementation
- âœ”ï¸ Pre-commit í›… í†µê³¼ (ESLint, í˜•ì‹ í™•ì¸)

---

## ğŸ§ª ê²€ì¦ ë°©ë²•

### ê°œë°œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸

1. **Console ë¡œê·¸ í™•ì¸**
   ```javascript
   // DevTools Consoleì—ì„œ í™•ì¸ ê°€ëŠ¥
   // App.tsxì—ì„œ ì €ì¥ ì‹œ:
   // "âœ… VAD metrics saved to localStorage"

   // SessionResultì—ì„œ ë³µì› ì‹œ:
   // "ğŸ¤ Loaded VAD metrics from localStorage: {...}"
   ```

2. **localStorage ì§ì ‘ í™•ì¸**
   ```javascript
   // DevTools â†’ Application â†’ Local Storage
   // 'bemore_last_session' í‚¤ í™•ì¸
   const data = JSON.parse(localStorage.getItem('bemore_last_session'));
   console.log(data.vadMetrics);
   ```

3. **End-to-End í…ŒìŠ¤íŠ¸**
   - ì„¸ì…˜ ì‹œì‘
   - 30ì´ˆ ì´ìƒ ì§„í–‰í•˜ì—¬ VAD ë©”íŠ¸ë¦­ìŠ¤ ìˆ˜ì§‘
   - "ì¢…ë£Œ" ë²„íŠ¼ í´ë¦­
   - ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
   - VAD ë©”íŠ¸ë¦­ìŠ¤ ê°’ì´ ì •ìƒ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

---

## ğŸ” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### localStorage ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
- ë¸Œë¼ìš°ì € DevTools â†’ Application â†’ Storage â†’ Clear All Sites
- í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸

### VAD ë©”íŠ¸ë¦­ìŠ¤ê°€ ì—¬ì „íˆ "-"ë¡œ í‘œì‹œë˜ëŠ” ê²½ìš°
- Consoleì—ì„œ ë‹¤ìŒ ëª…ë ¹ ì‹¤í–‰:
  ```javascript
  localStorage.getItem('bemore_last_session')
  ```
- ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì„¸ì…˜ ì €ì¥ ë‹¨ê³„ì—ì„œ `vadMetrics`ê°€ nullì¸ ìƒíƒœ
- API ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ WebSocket ì—°ê²° í™•ì¸

### localStorage ê³µê°„ ë¶€ì¡±
- ê¸°ì¡´ ì„¸ì…˜ ë°ì´í„° ì •ë¦¬:
  ```javascript
  localStorage.removeItem('bemore_last_session');
  ```

---

## ğŸ“Œ ì£¼ìš” í•™ìŠµ í¬ì¸íŠ¸

### 1. ìƒíƒœ ê´€ë¦¬ì˜ ë¼ì´í”„ì‚¬ì´í´ ì´í•´
- ìƒíƒœëŠ” ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì†ì‹¤ë¨
- ì¤‘ìš”í•œ ë°ì´í„°ëŠ” ì˜ì†ì„± ì €ì¥ì†Œì— ë³´ì¡´ í•„ìš”

### 2. WebSocket ì˜ì¡´ì„± ì²˜ë¦¬
- ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„°ëŠ” ì—°ê²° ì¢…ë£Œ ì‹œ ì†ì‹¤ ìœ„í—˜
- í•„ìš”ì‹œ ì£¼ìš” ìƒíƒœë¥¼ localStorage/sessionStorageì— ë°±ì—…

### 3. í´ë°± ì „ëµì˜ ì¤‘ìš”ì„±
- Props ìš°ì„  â†’ localStorage â†’ ê¸°ë³¸ê°’ ìˆœì„œë¡œ ì²´ê³„í™”
- ê° ë‹¨ê³„ë³„ ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…

### 4. ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- ë°ì´í„° ì†ì‹¤ ëŒ€ì‹  ìë™ ë³µêµ¬ë¡œ íˆ¬ëª…í•œ ì‚¬ìš© ê²½í—˜ ì œê³µ
- ë¡œê·¸ë¡œ ë°±ê·¸ë¼ìš´ë“œ ë™ì‘ ì¶”ì  ê°€ëŠ¥

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ ì°¸ê³ 
- SessionResult.tsx: ê²°ê³¼ íƒ­ ì»´í¬ë„ŒíŠ¸
- App.tsx: ì„¸ì…˜ ê´€ë¦¬ ë©”ì¸ ì»´í¬ë„ŒíŠ¸
- ToastContext.tsx: ì•Œë¦¼ ì‹œìŠ¤í…œ
- retryWithBackoff: API ì¬ì‹œë„ ë¡œì§

---

**ì‘ì„± ì¼ì‹œ**: 2025-11-05
**ì»¤ë°‹ í•´ì‹œ**: 305e056
**ìƒíƒœ**: âœ… ì™„ë£Œ ë° ê²€ì¦ ì™„ë£Œ
