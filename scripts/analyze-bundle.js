#!/usr/bin/env node

/**
 * Bundle Analysis Script
 * Generates bundle size report after vite build
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const distDir = path.join(__dirname, '../dist');

function formatBytes(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

function getDirectorySize(dirPath) {
  let size = 0;
  const files = fs.readdirSync(dirPath);

  files.forEach(file => {
    const filePath = path.join(dirPath, file);
    const stat = fs.statSync(filePath);

    if (stat.isDirectory()) {
      size += getDirectorySize(filePath);
    } else {
      size += stat.size;
    }
  });

  return size;
}

function analyzeBundle() {
  if (!fs.existsSync(distDir)) {
    console.error('âŒ dist directory not found. Please run build first.');
    process.exit(1);
  }

  const totalSize = getDirectorySize(distDir);
  const timestamp = new Date().toISOString();

  // Analyze individual files
  const files = [];
  fs.readdirSync(distDir).forEach(file => {
    const filePath = path.join(distDir, file);
    const stat = fs.statSync(filePath);

    if (stat.isFile()) {
      files.push({
        name: file,
        size: stat.size,
        sizeFormatted: formatBytes(stat.size),
      });
    }
  });

  files.sort((a, b) => b.size - a.size);

  // Generate report
  const report = `# Bundle Analysis Report

**Generated**: ${timestamp}

## Summary
- **Total Bundle Size**: ${formatBytes(totalSize)}
- **Files**: ${files.length}

## Top Files by Size
| File | Size |
|------|------|
${files.slice(0, 20).map(f => `| ${f.name} | ${f.sizeFormatted} |`).join('\n')}

## Breakdown
${files.map(f => `- ${f.name}: ${f.sizeFormatted}`).join('\n')}

## Recommendations
1. **Code Splitting**: Ensure large chunks are lazy-loaded
2. **Tree Shaking**: Verify unused dependencies are excluded
3. **Compression**: Gzip compression should reduce ~30-40% of size
4. **Monitoring**: Track bundle size in CI/CD pipeline

---
*Report generated by analyze-bundle.js*
`;

  // Write report to file
  const reportPath = path.join(__dirname, '../analysis/bundle-report.md');
  fs.mkdirSync(path.dirname(reportPath), { recursive: true });
  fs.writeFileSync(reportPath, report);

  console.log('âœ… Bundle analysis complete!');
  console.log(`ðŸ“Š Report saved to: ${reportPath}`);
  console.log(`\nðŸ“¦ Total Bundle Size: ${formatBytes(totalSize)}`);
  console.log(`ðŸ“‹ Files: ${files.length}`);
  console.log(`\nðŸ” Top 3 Files:`);
  files.slice(0, 3).forEach((f, i) => {
    console.log(`  ${i + 1}. ${f.name}: ${f.sizeFormatted}`);
  });
}

analyzeBundle();
